{% for doc in docs %}
  {% set record=getRecord(doc) %}
  {{ dump(record) }}
  {% set id=doc.id|trim %}
  {% set type=getFirstField(doc, 'type_ss') %}
  <div class="record">
    <h2>
      {% set tag245=getField(record, '245') %}
      {% set tag773=getField(record, '773') %}
      <i class="fa fa-{{ type2icon(type) }}" title="type: {{ type }}"></i>
      {% if tag245.subfields.a or tag245.subfields.b %}
        {% include 'search/conditional-foreach.html.twig' with {obj: tag245.subfields, key: 'a'} %}
        {% include 'search/conditional-foreach.html.twig' with {obj: tag245.subfields, key: 'b'} %}
      {% elseif tag773 %}
        {% include 'search/conditional-foreach.html.twig' with {obj: tag773.subfields, key: 't'} %}
        {% if tag245.subfields.n %}
          {% include 'search/conditional-foreach.html.twig' with {obj: tag245.subfields, key: 'n'} %}
        {% endif %}
      {% endif %}
      <a href="#" class="record-details" data="details-{{ id }}" title="display details"><i class="fa fa-info-circle" aria-hidden="true"></i></a>
      <a href="{{ opacLink(doc, id) }}" target="_blank" title="Display record in the library catalogue"><i class="fa fa-external-link" aria-hidden="true"></i></a>
    </h2>

    {% if attribute(tag245.subfields, 'c') is defined %}
      {% include 'search/conditional-foreach.html.twig' with {obj:tag245.subfields, key:'c',
        label:'<i class="fa fa-pencil" aria-hidden="true"></i>', suffix:'<br/>'} %}
    {% elseif attribute(tag773.subfields, 'a') is defined %}
      {% include 'search/conditional-foreach.html.twig' with {obj:tag773.subfields, key:'a',
        label:'<i class="fa fa-pencil" aria-hidden="true"></i>', suffix:'<br/>'} %}
    {% endif %}

    {% set tag250=getField(record, '250') %}
    {% if attribute(tag250, 'subfields') is defined %}
      {% include 'search/conditional-foreach.html.twig' with {obj:tag250.subfields, key:'a'} %}
    {% endif %}

    {# 260 Publication #}
    {% if hasPublication(doc) %}
      {% set tag260=getField(record, '260') %}
      <i class="fa fa-calendar" aria-hidden="true"></i>
      Published
      {# date #}
      {% include 'search/conditional-foreach.html.twig' with {obj:tag260.subfields, key:'c', label:'in', tag:'260c'} %}
      {# place #}
      {% include 'search/conditional-foreach.html.twig' with {obj:tag260.subfields, key:'a', label:'in', tag:'260a'} %}
      {# agent #}
      {% include 'search/conditional-foreach.html.twig' with {obj:tag260.subfields, key:'b', label:'by', tag:'260b'} %}
      <br/>
    {% endif %}

    {# PhysicalDescription #}
    {% if hasPhysicalDescription(doc) %}
      {% set tag300=getField(record, '300') %}
      {# extent #}
      {% include 'search/conditional-foreach.html.twig' with {obj:tag300.subfields, key:'a', tag:'300a'} %}
      {# dimensions #}
      {% include 'search/conditional-foreach.html.twig' with {obj:tag300.subfields, key:'c', tag:'300c'} %}
      <br/>
    {% endif %}

    {# SeriesStatement #}
    {% set tag490=getField(record, '490') %}
    {% if tag490 != null %}
      {% if attribute(tag490.subfields, 'a') is defined %}
        Series:
        {% for tag490 in record.490 %}
          <a href="{{
            path('search', {
            'query': '490a_SeriesStatement_ss:"' ~ attribute(tag490.subfields, 'a')|escape ~ '"'
            })
          }}" class="record-link tag-490a" data="490a_SeriesStatement_ss">{{
            attribute(tag490.subfields, 'a') }}</a>
          {% if attribute(tag490.subfields, 'v') is defined %}
            {{ attribute(tag490.subfields, 'v') }}
          {% endif %}
          {% if not loop.last %}, {% endif %}
        {% endfor %}
        <br/>
      {% endif %}
    {% endif %}

    {# 520a_Summary_ss #}
    {% if record.520 is defined %}
      {% for tag in record.520 %}
        {{ attribute(tag.subfields, 'a') }}<br/>
      {% endfor %}
    {% endif %}

    {# 505a_TableOfContents_ss #}
    {% if record.505 is defined %}
      {% for tag in record.505 %}
        {{ attribute(tag.subfields, 'a') }}<br/>
      {% endfor %}
    {% endif %}

    {# 100a_MainPersonalName_personalName_ss #}
    {% if hasMainPersonalName(doc) %}
      <i class="fa fa-user" aria-hidden="true" title="personal name"></i>
      {% for tag in record.100 %}
        <a href="{{ path('search', {
          'query': '100a_MainPersonalName_personalName_ss:"' ~ attribute(tag.subfields, 'a')|escape ~ '"'
        }) }}" class="record-link" data="100a_MainPersonalName_personalName_ss">{{ attribute(tag.subfields, 'a') }}</a>
          {# 100d_MainPersonalName_dates_ss #}
          {% if attribute(tag.subfields, 'd') is defined %}
            {{ attribute(tag.subfields, 'd') }}
          {% endif %}
          {% if not loop.last %}, {% endif %}
      {% endfor %}
      <br/>
    {% endif %}

    {# 700a_AddedPersonalName_personalName_ss #}
    {% if record.700 is defined %}
      <i class="fa fa-user" aria-hidden="true" title="personal name"></i>
      {% for tag in record.700 %}
        <a href="{{ path('search', {
          'query': '700a_AddedPersonalName_personalName_ss:"' ~ attribute(tag.subfields, 'a')|escape ~ '"'
          }) }}" class="record-link" data="700a_AddedPersonalName_personalName_ss">{{ attribute(tag.subfields, 'a')
        }}</a>{# 700d_AddedPersonalName_dates_ss #}{% if attribute(tag.subfields, 'd') is defined %}
          {{ attribute(tag.subfields, 'd') }}
        {% endif %}{% if not loop.last %}, {% endif %}
      {% endfor %}
      <br/>
    {% endif %}

    {# 710a_AddedCorporateName_ss #}
    {% if record.710 is defined %}
      <i class="fa fa-user" aria-hidden="true" title="corporate name"></i>
      {% for tag in record.710 %}
        <a href="{{ path('search', {
        'query': '710a_AddedCorporateName_ss:"' ~ attribute(tag.subfields, 'a')|raw ~ '"'
      }) }}" class="record-link" data="710a_AddedCorporateName_ss">{{ attribute(tag.subfields, 'a')|raw
      }}</a>{# 710d_AddedCorporateName_dates #}{% if attribute(tag.subfields, 'd') is defined %}
        {{ attribute(tag.subfields, 'd') }}
      {% endif %}{% if not loop.last %}, {% endif %}
      {% endfor %}
      <br/>
    {% endif %}

    {# 650a_Topic_topicalTerm_ss #}
    {% if record.650 is defined %}
      {% for tag in record.650 %}
        <i class="fa fa-hashtag" aria-hidden="true" title="topical term"></i>
        {% include 'search/subfield-link.html.twig' with
          {tag:tag, code:'a', solr_field:'650a_Topic_topicalTerm_ss'} %}

        {# 650b_Topic_topicalTerm_ss #}
        {% if attribute(tag.subfields, 'b') is defined %}
          <i class="fa fa-tag" aria-hidden="true" title="form"></i>
          {% include 'search/subfield-link.html.twig' with
            {tag:tag, code:'b', solr_field:'650b_Topic_topicalTerm_ss'} %}
        {% endif %}

        {# 650v_Topic_formSubdivision_ss #}
        {% if attribute(tag.subfields, 'v') is defined %}
          <i class="fa fa-tag" aria-hidden="true" title="form"></i>
          {% include 'search/subfield-link.html.twig' with
            {tag:tag, code:'v', solr_field:'650v_Topic_formSubdivision_ss'} %}
        {% endif %}

        {# 650x_Topic_generalSubdivision_ss #}
        {% if attribute(tag.subfields, 'x') is defined %}
          <i class="fa fa-tag" aria-hidden="true" title="form"></i>
          {% include 'search/subfield-link.html.twig' with
            {tag:tag, code:'x', solr_field:'650x_Topic_generalSubdivision_ss'} %}
        {% endif %}

        {# 650y_Topic_chronologicalSubdivision_ss #}
        {% if attribute(tag.subfields, 'y') is defined %}
          <i class="fa fa-tag" aria-hidden="true" title="form"></i>
          {% include 'search/subfield-link.html.twig' with
            {tag:tag, code:'y', solr_field:'650y_Topic_chronologicalSubdivision_ss'} %}
        {% endif %}

        {# 650z_Topic_geographicSubdivision_ss #}
        {% if attribute(tag.subfields, 'z') is defined %}
          <i class="fa fa-map" aria-hidden="true" title="geographic subdivision"></i>
          {% include 'search/subfield-link.html.twig' with
            {tag:tag, code:'z', solr_field:'650z_Topic_geographicSubdivision_ss'} %}
        {% endif %}

        {# 6500_Topic_authorityRecordControlNumber_ss #}
        {% if attribute(tag.subfields, '0') is defined %}
          <i class="fa fa-tag" aria-hidden="true" title="form"></i>
          {% include 'search/subfield-link.html.twig' with
            {tag:tag, code:'0', solr_field:'6500_Topic_authorityRecordControlNumber_ss'} %}
        {% endif %}

        {% if attribute(tag.subfields, '2') is defined %}
          <i class="fa fa-tag" aria-hidden="true" title="form"></i>
          {% include 'search/subfield.html.twig' with {tag:tag, code:'2'} %}
        {% endif %}

        <br/>
      {% endfor %}
    {% endif %}

    {# 651a_Geographic_ss #}
    {% if record.651 is defined %}
      {% for tag in record.651 %}
        <i class="fa fa-map" aria-hidden="true" title="topical term"></i>
        {% include 'search/subfield-link.html.twig' with
          {tag:tag, code:'a', solr_field:'651a_Geographic_ss'} %}

        {# 651v_Geographic_formSubdivision_ss #}
        {% if attribute(tag.subfields, 'v') is defined %}
          <i class="fa fa-tag" aria-hidden="true" title="form"></i>
          {% include 'search/subfield-link.html.twig' with
            {tag:tag, code:'v', solr_field:'651v_Geographic_formSubdivision_ss'} %}
        {% endif %}

        {# 651x_Geographic_generalSubdivision_ss #}
        {% if attribute(tag.subfields, 'x') is defined %}
          <i class="fa fa-tag" aria-hidden="true" title="form"></i>
          {% include 'search/subfield-link.html.twig' with
            {tag:tag, code:'x', solr_field:'651x_Geographic_generalSubdivision_ss'} %}
        {% endif %}

        {# 651y_Geographic_chronologicalSubdivision_ss #}
        {% if attribute(tag.subfields, 'y') is defined %}
          <i class="fa fa-tag" aria-hidden="true" title="form"></i>
          {% include 'search/subfield-link.html.twig' with
            {tag:tag, code:'y', solr_field:'651y_Geographic_chronologicalSubdivision_ss'} %}
        {% endif %}

        {# 651z_Geographic_geographicSubdivision_ss #}
        {% if attribute(tag.subfields, 'z') is defined %}
          <i class="fa fa-tag" aria-hidden="true" title="form"></i>
          {% include 'search/subfield-link.html.twig' with
            {tag:tag, code:'z', solr_field:'651z_Geographic_geographicSubdivision_ss'} %}
        {% endif %}

        {# 6510_Geographic_authorityRecordControlNumber_ss #}
        {% if attribute(tag.subfields, '0') is defined %}
          <i class="fa fa-tag" aria-hidden="true" title="form"></i>
          {% include 'search/subfield-link.html.twig' with
            {tag:tag, code:'0', solr_field:'6510_Geographic_authorityRecordControlNumber_ss'} %}
        {% endif %}

        {% if attribute(tag.subfields, '2') is defined %}
          <i class="fa fa-tag" aria-hidden="true" title="form"></i>
          {% include 'search/subfield.html.twig' with {tag:tag, code:'2'} %}
        {% endif %}

        <br/>
      {% endfor %}
    {% endif %}

    {% if hasSimilarBooks(doc) %}
      <div class="similarity">
        <i class="fa fa-search" aria-hidden="true"></i>
        Search for similar items:
        {% if attribute(doc, '9129_WorkIdentifier_ss') is defined %}
          works:
          {% include 'search/link.html.twig' with {value:attribute(doc, '9129_WorkIdentifier_ss'), solr_field:'9129_WorkIdentifier_ss'} %}
        {% endif %}
        {% if attribute(doc, '9119_ManifestationIdentifier_ss') is defined %}
          manifestations:
          {% include 'search/link.html.twig' with {value:attribute(doc, '9119_ManifestationIdentifier_ss'), solr_field:'9119_ManifestationIdentifier_ss'} %}
        {% endif %}
      </div>
    {% endif %}

    <div class="details" id="details-{{ id }}">
      <ul class="nav nav-tabs" id="record-views-{{ id }}">
        <li class="nav-item">
          <a class="nav-link active" data-toggle="tab" role="tab" aria-selected="true"
             id="marc-raw-tab-{{ id }}" href="#marc-raw-{{ id }}"
             aria-controls="marc-raw-tab">MARC21</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" data-toggle="tab" role="tab" aria-selected="true"
             id="marc-leader-tab-{{ id }}" href="#marc-leader-{{ id }}"
             aria-controls="marc-leader-tab">Leader explained</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" data-toggle="tab" role="tab" aria-selected="true"
             id="marc-008-tab-{{ id }}" href="#marc-008-{{ id }}"
             aria-controls="marc-008-tab">008 explained</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" data-toggle="tab" role="tab" aria-selected="false"
             id="marc-human-tab-{{ id }}" href="#marc-human-{{ id }}"
             aria-controls="marc-human-tab">labels</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" data-toggle="tab" role="tab" aria-selected="false"
             id="marc-issue-tab-{{ id }}" href="#marc-issue-{{ id }}"
             aria-controls="marc-issue-tab" data-id="{{ id }}">issues</a>
        </li>
      </ul>
      <div class="tab-content">
        <div class="tab-pane active" id="marc-raw-{$id}" role="tabpanel" aria-labelledby="data-tab">
          <div class="marc-details" id="marc-details-{$id}">
            {% if doc.record_sni is defined %}
            <table>
              {% for row in getMarcFields(doc) %}
              <tr>
                {% for cell in row %}
                  <td>{{ cell }}</td>
                {% endfor %}
              </tr>
              {% endfor %}
            </table>
            {% endif %}
          </div>
        </div>
        <div class="tab-pane" id="marc-human-{$id}" role="tabpanel" aria-labelledby="data-tab">
          <ul>
            {% for field in getAllSolrFields(doc) %}
              <li>
                <span class="label">{{ field.label }}:</span>
                {% for value in field.value %}
                  {{ value }}{% if not loop.last %} &mdash; {% endif %}
                {% endfor %}
              </li>
            {% endfor %}
          </ul>
        </div>
        <div class="tab-pane" id="marc-issue-{$id}" role="tabpanel" aria-labelledby="data-tab">
          <p>Retrieving issues detected in this MARC record (if any). It might take for a while.</p>
        </div>
      </div>
    </div>
  </div>
{% endfor %}